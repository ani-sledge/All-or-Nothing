<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <!--JQuery, jQuery.ui-->
    <script   src="https://code.jquery.com/jquery-1.12.3.min.js"   integrity="sha256-aaODHAgvwQW1bFOGXMeX+pC4PZIPsvn2h1sArYOhgXQ="   crossorigin="anonymous"></script>
    <script   src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"   integrity="sha256-xNjb53/rY+WmG+4L6tTl9m6PpqknWZvRt0rO1SRnJzw="   crossorigin="anonymous"></script>
    <link href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.min.css" rel="stylesheet" type="text/css" />
    <!--Bootstrap-->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>
    <style>
      .tricks {
        width: 100px;
      }
      input[type=text] {
        border: solid 1px #fff;
      }
      input[type=text]:focus, input[type=text].focus {
        border: solid 1px #999;
      }
    </style>
    <title>All or Nothing Scorecard</title>
  </head>
  <body>
    <div id="main" class="container-fluid">
      <h1>All or Nothing</h1>
      <table id="game" class="table">
        <tr id="table-names">
          <th>Name</th>
        </tr>
        <tr id="score">
          <td>Score</td>
        </tr>
        <tr id="tricks">
          <td>Tricks Taken</td>
        </tr>
        <tr id="bid">
          <td>Bid</td>
        </tr>
      </table>
      <button id="next-round">Next Round</button>
    </div>
    <script>
      var active = true;
      var round = 1;

      var players = [
        {
          name: "New Player",
          score: 100,
          tricks: 0,
          all: false
        },
        {
          name: "New Player",
          score: 100,
          tricks: 0,
          all: false
        }
      ]

      var getPlace = function(num) {
        if (num == 1) {
          return '1st';
        } else if (num == 2) {
          return '2nd';
        } else if (num == 3) {
          return '3rd';
        } else {
          return num + "th";
        }
      }

      var tricksTotal = function() {
        var total = 0;
        for (i = 0; i < players.length; i++) {
          total += players[i]['tricks'];
        }
        return total;
      }

      var calculateScore = function(score, tricks, tricks_total, all) {
        if (all) {
          if (tricks == tricks_total) {
            score -= 100;
          } else {
            score += (tricks_total - tricks) * 10;
          }
        } else {
          if (tricks == 0) {
            score -= 20;
          } else {
            score += tricks * 10;
          }
        } 
        return score;
      }

      var setBid = function(checkbox) {
        var current_player = players[Number(checkbox.id[0])];
        var label = $("label[for='" + checkbox.id + "']");
        if (checkbox.checked) {
          current_player['all'] = true;
          label.html("All");
        } else {
          current_player['all'] = false;
          label.html("Nothing");
        }
      }


      $( document ).ready(function() {
          for (i = 0; i < players.length; i++) {
            //INITIALIZE TABLE
            $('#table-names').append("<th><input class='namefield' id='" + i + "-name' type='text' name='name' placeholder='New Player'></th>");
            
            $('#score').append("<td class='score' id='" + i + "-score'>" + players[i]['score'] + "</td>");
            $('#tricks').append("<td><div class='tl' id='" + i + "-tl'>0</div><div class='tricks' id='" + i + "-tricks'></div></td>");
            $('#bid').append(
              "<td><input class='bid' type='checkbox' name='bid' id='" + i + "-bid' value='all'> <label for='" + i + "-bid'>Nothing</label></id>");
          }
          $("<h3 id='round'>Round: 1</h3>").insertAfter("h1");
          
          //ADD EVENT LISTENERS
          $(".tricks").slider({
            max: 10,
            stop: function( event, ui ) {
              players[Number(this.id[0])]['tricks'] = ui.value;
            },
            slide: function( event, ui ) {
              $("#" + this.id[0] + "-tl").html(ui.value);
            }
          });
          $('.bid').change(function() {
            setBid(this);
          });
          $('.namefield').blur(function() {
            var current_player = players[Number(this.id[0])];
            current_player['name'] = this.value;
          });

          $("#next-round").click(function() {
            if (round <= 10 && active) {
              round += 1;
              $('#round').html('Round: ' + round);
              $(".tricks").slider('value', 0);
              $(".tl").html("0");
              $("input[type='checkbox']").attr('checked', false);

              var scores = $(".score");
              var boxes = $("input[type='checkbox']"); 
              var total = tricksTotal();
              for (i = 0; i < players.length; i++) {
                var player = players[i];
                players[i]['score'] = calculateScore(players[i]['score'], players[i]['tricks'], total, players[i]['all']);
                setBid(boxes[i]);
                players[i]['tricks'] = 0;
                $("#" + i + "-score" ).html( players[i]['score']);
                console.log(players[i]);
              }
            }
            for (i = 0; i < players.length; i++) {
              if (players[i]['score'] <= 0) {
                active = false;
              }
            }
          });

      });
    </script>
  </body> 
</html>